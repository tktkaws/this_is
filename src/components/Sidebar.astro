---
import { getCollection, render } from 'astro:content';
import type { MarkdownHeading } from 'astro';

interface Props {
	currentSlug: string;
}

const { currentSlug } = Astro.props;

const pages = await getCollection('pages');

const sidebarCategories = [
	{ label: '自己紹介', directory: 'introduction' },
	{ label: '技術スタック', directory: 'skills' },
	{ label: '職歴・経歴', directory: 'career' },
	{ label: 'プロジェクト実績', directory: 'projects' },
	{ label: '連絡先', directory: 'contact' },
];

const sidebarItems = await Promise.all(
	sidebarCategories.map(async (cat) => {
		const page = pages.find((p) => p.id === cat.directory);
		const href = `/${cat.directory}/`;
		const isActive = currentSlug === cat.directory || currentSlug.startsWith(cat.directory + '/');
		let tocHeadings: MarkdownHeading[] = [];
		if (page) {
			const { headings } = await render(page);
			tocHeadings = headings.filter((h) => h.depth >= 2 && h.depth <= 3);
		}
		return { label: cat.label, href, isActive, tocHeadings };
	})
);
---

<aside class="hidden lg:block w-64 shrink-0 border-r border-[var(--color-border)] bg-[var(--color-bg)]">
	<nav class="sticky top-14 h-[calc(100vh-3.5rem)] overflow-y-auto py-8 pr-4 pl-4" aria-label="サイドバー">
		<ul class="sidebar-list space-y-1">
			{sidebarItems.map((item) => (
				<li>
					{item.tocHeadings.length > 0 ? (
						<details class="group" open={item.isActive}>
							<summary
								class:list={[
									'flex items-center gap-1 py-1 text-sm transition-colors cursor-pointer list-none',
									item.isActive
										? 'text-[var(--color-text)] font-medium'
										: 'text-[var(--color-text-secondary)] hover:text-[var(--color-text)]',
								]}
								aria-current={item.isActive ? 'page' : undefined}
							>
								<svg class="w-3 h-3 shrink-0 transition-transform group-open:rotate-90" fill="currentColor" viewBox="0 0 20 20">
									<path d="M6 4l8 6-8 6V4z" />
								</svg>
								<a href={item.href} class="hover:text-[var(--color-text)]">{item.label}</a>
							</summary>
							<ul class="space-y-1 ml-3 mt-1 border-l border-[var(--color-border)]">
								{item.tocHeadings.map((heading) => (
									<li>
										<a
											href={`${item.href}#${heading.slug}`}
											class:list={[
												'block py-1 text-sm transition-colors text-[var(--color-text-secondary)] hover:text-[var(--color-text)]',
												heading.depth === 3 ? 'pl-6' : 'pl-3',
											]}
											{...(item.isActive ? { 'data-toc-link': '', 'data-heading-slug': heading.slug } : {})}
										>
											{heading.text}
										</a>
									</li>
								))}
							</ul>
						</details>
					) : (
						<div class="flex items-center gap-1 py-1">
							<svg class="w-3 h-3 shrink-0 text-[var(--color-text-secondary)]" fill="currentColor" viewBox="0 0 20 20">
								<path d="M6 4l8 6-8 6V4z" />
							</svg>
							<a
								href={item.href}
								class:list={[
									'text-sm transition-colors',
									item.isActive
										? 'text-[var(--color-text)] font-medium'
										: 'text-[var(--color-text-secondary)] hover:text-[var(--color-text)]',
								]}
								aria-current={item.isActive ? 'page' : undefined}
							>
								{item.label}
							</a>
						</div>
					)}
				</li>
			))}
		</ul>
	</nav>
</aside>

<script>
	function initToc() {
		const links = document.querySelectorAll('[data-toc-link]');
		if (links.length === 0) return;

		const headingIds = Array.from(links).map((link) =>
			(link as HTMLElement).dataset.headingSlug!
		);

		const observer = new IntersectionObserver(
			(entries) => {
				for (const entry of entries) {
					if (entry.isIntersecting) {
						links.forEach((link) => {
							const slug = (link as HTMLElement).dataset.headingSlug;
							if (slug === entry.target.id) {
								link.classList.add('!text-primary-600', 'dark:!text-primary-400', 'font-medium');
							} else {
								link.classList.remove('!text-primary-600', 'dark:!text-primary-400', 'font-medium');
							}
						});
					}
				}
			},
			{ rootMargin: '-80px 0px -80% 0px' }
		);

		headingIds.forEach((id) => {
			const el = document.getElementById(id);
			if (el) observer.observe(el);
		});
	}

	initToc();
	document.addEventListener('astro:after-swap', initToc);
</script>

<style>
	.sidebar-list summary::-webkit-details-marker,
	.sidebar-list summary::marker {
		display: none;
	}
</style>
